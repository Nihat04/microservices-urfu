# API Gateway с агрегацией данных и кэшированием (Backend for Frontend)
**Реализовано:**
    - 3 микросервиса
    - API Gateway (агрегация запросов)
    - Логирование (сбор логов, парсинг  и хранение логов, пока что с одного сервиса) 
    - Метрики (сбор, хранение и педставление, пока что с одного сервиса) 
**Пока что не реализовано:**
  - Кэшировнаие
  - Авторизация и аутентификация на стороне Gateway
  - Метрики и логи пока, что собираются только с одного микросервиса, но там нужно в конфиге пару строчек добавить и добавить на сервисов запись логов и метрик
  - Gateway предоставляет доступ только к некоторым ручкам из микросервисов (не успели написать)

### Описание  микросервисов

#### **GatewayService**

API Gateway - единая точка входа для всех клиентских запросов. Маршрутизирует запросы к соответствующим микросервисам (UserService, OrderService, ProductService).

**Swagger UI для тестирования:**

**http://localhost:8086/swagger**

**Эндпоинты:**

1. **`POST /auth/login`**

    - **Описание:** Аутентификация пользователя.

    - **Параметры:** `LoginRequest` (email, пароль).

    - **Возвращает:** `AuthResponse` (JWT токен доступа).

    - **Маршрутизация:** `UserService` (`http://user_service:8080/auth/auth/login`).

2. **`POST /users/register`**

    - **Описание:** Регистрация нового пользователя.

    - **Параметры:** `RegisterRequest` (email, полное имя, пароль).

    - **Возвращает:** `RegisterResponse` (информация о зарегистрированном пользователе).

    - **Маршрутизация:** `UserService` (`http://user_service:8080/auth/auth/register`).

3. **`POST /create-order`**

    - **Описание:** Создание нового заказа. Gateway автоматически блокирует товары на складе перед созданием заказа.

    - **Параметры:** `OrderCreateRequest` (содержит список товаров с количеством и ценой).

    - **Возвращает:** `OrderResponse` (информация о созданном заказе).

    - **Маршрутизация:** 

        - Сначала вызывает `ProductService` для бронирования каждого товара (`POST /api/v1/products/{productId}/book?quantity={quantity}`)

        - Затем создает заказ через `OrderService` (`POST /api/v1/orders`).

4. **`GET /get-orders`**

    - **Описание:** Получение списка всех заказов с пагинацией.

    - **Параметры:** Отсутствуют.

    - **Возвращает:** `PaginatedResult<OrderResponse>`.

    - **Маршрутизация:** `OrderService` (`http://order_service:8080/api/v1/orders/list`).

5. **`GET /products`**

    - **Описание:** Получение списка всех товаров с пагинацией, сортировкой и фильтрацией.

    - **Параметры:** 

        - `pagination` (номер страницы и размер страницы),

        - `sortBy` (сортировка по названию, цене или дате создания),

        - `sortOrder` (порядок сортировки: по возрастанию или убыванию),

        - `filter` (фильтрация по параметрам товара).

    - **Возвращает:** `PaginatedResult<ProductResponse>`.

    - **Маршрутизация:** `ProductService` (`http://product_service:8080/api/v1/products/list`).

6. **`POST /products`**

    - **Описание:** Создание нового товара.

    - **Параметры:** `ProductCreateRequest` (название, цена, количество).

    - **Возвращает:** `ProductResponse` (информация о созданном товаре).

    - **Маршрутизация:** `ProductService` (`http://product_service:8080/api/v1/products`).

---

#### **OrderService**

Микросервис для управления заказами.

**Эндпоинты:**

1. **`POST /api/v1/orders`**

    - **Описание:** Создание нового заказа.

    - **Параметры:** `OrderCreateRequest` (содержит `UserId` и список товаров с количеством и ценой).

    - **Возвращает:** `OrderResponse` (информация о созданном заказе).

2. **`GET /api/v1/orders/{id}`**

    - **Описание:** Получение заказа по идентификатору.

    - **Параметры:** `id` (GUID заказа).

    - **Возвращает:** `OrderResponse` или 404, если заказ не найден.

3. **`GET /api/v1/orders`**

    - **Описание:** Получение списка заказов по идентификаторам.

    - **Параметры:** `ids` (массив GUID заказов).

    - **Возвращает:** Массив `OrderResponse`.

4. **`GET /api/v1/orders/list`**

    - **Описание:** Получение списка заказов с пагинацией, сортировкой и фильтрацией.

    - **Параметры:**

        - `pagination` (номер страницы и размер страницы),

        - `sortBy` (сортировка по времени создания или обновления),

        - `sortOrder` (порядок сортировки: по возрастанию или убыванию),

        - `filter` (фильтрация по пользователю, датам или статусу заказа).

    - **Возвращает:** `PaginatedResult<OrderResponse>`.

5. **`POST /api/v1/orders/pay/{id}`**

    - **Описание:** Оплата заказа.

    - **Параметры:** `id` (GUID заказа).

    - **Возвращает:** `OrderResponse` или 400, если заказ не может быть оплачен.

6. **`POST /api/v1/orders/complete/{id}`**

    - **Описание:** Завершение заказа.

    - **Параметры:** `id` (GUID заказа).

    - **Возвращает:** `OrderResponse` или 400, если заказ не может быть завершён.

7. **`DELETE /api/v1/orders/{id}`**

    - **Описание:** Отмена заказа.

    - **Параметры:** `id` (GUID заказа).

    - **Возвращает:** `OrderResponse` или 400, если заказ не может быть отменён.

---

#### **ProductService**

Микросервис для управления товарами.

**Эндпоинты:**

1. **`POST /api/v1/products`**

    - **Описание:** Создание нового товара.

    - **Параметры:** `ProductCreateRequest` (название, цена, количество).

    - **Возвращает:** `ProductResponse` (информация о созданном товаре) или 400 - некорректные данные.

2. **`GET /api/v1/products/{id}`**

    - **Описание:** Получение товара по идентификатору.

    - **Параметры:** `id` (GUID товара).

    - **Возвращает:** `ProductResponse` или 404, если товар не найден.

3. **`GET /api/v1/products`**

    - **Описание:** Получение списка товаров по идентификаторам.

    - **Параметры:** `ids` (массив GUID товаров).

    - **Возвращает:** Массив `ProductResponse`.

4. **`GET /api/v1/products/list`**

    - **Описание:** Получение списка товаров с пагинацией, сортировкой и фильтрацией.

    - **Параметры:**

        - `pagination` (номер страницы и размер страницы),

        - `sortBy` (сортировка по названию, цене или дате создания),

        - `sortOrder` (порядок сортировки: по возрастанию или убыванию),

        - `filter` (фильтрация по параметрам товара).

    - **Возвращает:** `PaginatedResult<ProductResponse>`.

5. **`POST /api/v1/products/{id}/book`**

    - **Описание:** Бронирование товара.

    - **Параметры:** `id` (GUID товара), `quantity` (количество).

    - **Возвращает:** `ProductResponse` или 400, если товар не может быть забронирован.

6. **`POST /api/v1/products/{id}/cancel-book`**

    - **Описание:** Отмена бронирования товара.

    - **Параметры:** `id` (GUID товара), `quantity` (количество).

    - **Возвращает:** `ProductResponse` или 400, если бронирование не может быть отменено.

7. **`POST /api/v1/products/{id}/add`**

    - **Описание:** Добавление товара на склад.

    - **Параметры:** `id` (GUID товара), `quantity` (количество).

    - **Возвращает:** `ProductResponse` или 400, если товар не может быть добавлен.

8. **`POST /api/v1/products/{id}/ship`**

    - **Описание:** Отгрузка товара.

    - **Параметры:** `id` (GUID товара), `quantity` (количество).

    - **Возвращает:** `ProductResponse` или 400, если товар не может быть отгружен.

9. **`DELETE /api/v1/products/{id}`**

    - **Описание:** Удаление товара.

    - **Параметры:** `id` (GUID товара).

    - **Возвращает:** `ProductResponse` или 400, если товар не может быть удалён.

---

#### **UserService**

Микросервис для управления пользователями и аутентификацией.

**Эндпоинты:**

1. **`POST /auth/register`**

    - **Описание:** Регистрация нового пользователя.

    - **Параметры:** `RegisterRequest` (email, полное имя, пароль).

    - **Возвращает:** `RegisterResponce` (информация о зарегистрированном пользователе).

    - **Ошибки:** 400 - некорректные данные или ошибка валидации.

2. **`POST /auth/login`**

    - **Описание:** Аутентификация пользователя.

    - **Параметры:** `LoginRequest` (email, пароль).

    - **Возвращает:** `AuthResponce` (токен доступа) или 401, если аутентификация не удалась.

---

Эти эндпоинты будут доступны через API Gateway, который будет маршрутизировать запросы к соответствующим микросервисам.

## Мониторинг и логирование

### Метрики

**Стек:**

-   OpenTelemetry - сбор метрик

-   Prometheus - хранение метрик

-   Grafana - визуализация

**Сбор метрик:**

Метрики собираются через OpenTelemetry с инструментацией ASP.NET Core. Микросервисы экспортируют метрики в формате Prometheus через endpoint `/metrics`. Prometheus периодически собирает метрики со всех микросервисов и хранит их в своей базе данных.

**Визуализация:**

Визуализация метрик выполняется в Grafana через подключенный datasource Prometheus и подключенный дашборд.

### Логи

**Стек:**

-   Serilog - логирование в приложении

-   Vector - сбор и предобработка логов

-   Loki - хранение логов

-   Grafana - визуализация

**Сбор логов:**

Логи собираются через Serilog, который выводит их в консоль в формате JSON с обогащением (добавляется имя сервиса). Vector собирает логи из Docker-контейнеров, парсит JSON-сообщения и отправляет их в Loki с метками (service, level).

**Предобработка:**

Vector выполняет парсинг JSON-логов из контейнеров и добавляет метки для последующей фильтрации и поиска в Loki.

**Визуализация:**

Визуализация логов выполняется в Grafana через подключенный datasource Loki.
